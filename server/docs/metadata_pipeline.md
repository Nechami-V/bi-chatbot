# תהליך טעינת המטא-דאטה

מסמך זה מסביר כיצד הטעינה מתבצעת כיום: הסכימה ל-GPT נוצרת מראש משילוב של מטא-דאטה רשמי, רשימת עמודות אמיתית מה-DB והרחבות ידניות, ונשמרת כ-YAML שנקרא בזמן ריצה. אין גישה למסד המטא בזמן שהשירות עובד.

## 1. הגדרות וחיבור
- בקובץ `app/simple_config.py` מוגדר המשתנה `METADATA_DATABASE_URL`, שמצביע על מסד ה-SQL Server שבו נמצאות טבלאות המטא (`MetaTables`, `MetaColumns`, `MetaRelations`, `MetaIndexes`, `MetaDefaults`).
- הסקריפט `scripts/export_meta_schema.py` בונה חיבור SQLAlchemy ישיר לכתובת הזו ומושך את הנתונים בעת הריצה שלו בלבד.

## 2. סקריפט ייצוא META_SCHEMA
- הסקריפט `scripts/export_meta_schema.py` מרכיב את הקובץ המשולב בשלבים הבאים:
  1. קריאת כל טבלאות המטא הרשמיות (`MetaTables`, `MetaColumns`, `MetaRelations`, `MetaIndexes`, `MetaDefaults`).
  2. איתור טבלאות מטא נוספות (כגון מילוני תרגום או דוגמאות שאילתות) ושילובן: כינויים מתווספים לעמודות/טבלאות, ודוגמאות נשמרות לשימוש עתידי.
  3. סידור התוצר ושמירתו בפורמט YAML קריא עבור ה-AI.
- התוצר נכתב ל-`configs/schemas/META_SCHEMA.yaml`. מריצים את הסקריפט בכל פעם שמתעדכן המטא הרשמי.

## 3. קבצי עזר
- `scripts/generate_extra_yaml.py` – נשמר לסבבי תחזוקה עתידיים בלבד, אך אינו חלק מתהליך הייצוא הנוכחי.

## 4. שילוב בשירות ה-AI
- `app/services/ai_service.py` מפעיל את `_analyze_database_schema` בעת האתחול:
  1. טוענת את `META_SCHEMA.yaml` באמצעות `config_loader.load_meta_schema()`.
  2. אם הקובץ קיים ומכיל טבלאות – הסכימה נטענת ל-`self.schema_info` ואין גישה למסד המטא בזמן ריצה.
  3. אם הקובץ חסר או ריק, נופלים ל-YAML הישן של הלקוח (כלומר למבנה האונטולוגיה ההיסטורי).
- בניית הפרומפט (`_build_sql_prompt`) ממירה את הסכימה ל-JSON קומפקטי בעזרת `json.dumps`, כך שהמודל מקבל את הטבלאות והעמודות המעודכנות כולל ההרחבות.
- בנוסף לטבלאות ויחסים, הקובץ כולל היום מפת `translations` (כינויים שנאספו מהמטא) ואוסף `examples` לשאלות/תשובות שמורות – שניהם זמינים להרחבות עתידיות של השירות.

## 5. תמיכה בשאלות המשך
- `app/simple_memory.py` שומר היסטוריה קצרה לכל משתמש. כל תשובה כוללת גם את ה-SQL שבוצע.
- בעת יצירת פרומפט חדש, `_select_relevant_tables` ו-`_build_sql_prompt` מקבלים את ההקשר המעובד (שאלה, תשובה ו-SQL). ההוראות מדגישות שימוש חוזר בסינונים קודמים כדי לענות על שאלות המשך.

## 6. גיבוי ל-YAML
- אם הטעינה מהמטא נכשלת או מחזירה סכימה ריקה, המתודה `_load_schema_from_yaml` טוענת את האונטולוגיה ואת מיפוי הטבלאות מתיקיית `configs/` דרך `config_loader`.
- במקרי חירום מתבצעת גם בדיקה ישירה של מסד הנתונים התפעולי (`_fallback_schema_analysis`), בדומה להתנהגות ההיסטורית של המערכת.

## 7. בדיקות
- מומלץ להריץ את `scripts/export_meta_schema.py` בסביבת פיתוח לאחר כל שינוי במטא, ולבדוק ש-`META_SCHEMA.yaml` עודכן והתוכן כולל את הטבלאות, העמודות, התרגומים והדוגמאות החדשות.

## 8. זרימת הבקשות
1. המשתמש שואל שאלה בשפה טבעית.
2. `ChatbotService.process_question` מושך הקשר מ-`session_memory` ומזמן את `AIService.generate_sql` עם ה-JSON של הסכימה.
3. ה-SQL שנוצר רץ מול מסד הלקוח דרך SQLAlchemy.
4. התשובה וה-SQL נשמרים שוב בזיכרון כדי לחזק שאילתות המשך.

העיצוב משאיר את המטא הרשמי כמקור אמת, אבל מאפשר להשלים עמודות חסרות באמצעות קבצי העזר – כך שהסכימה שמגיעה ל-GPT מלאה ועדכנית, בלי מגע ישיר במסד בזמן ריצה.
